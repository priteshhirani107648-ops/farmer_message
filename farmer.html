<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="app-version" content="1.0.5">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>àª¨à«€àª²àª•àª‚àª  àª«à«àª°à«‚àªŸ àªàª¨à«àª¡ àªµà«‡àªœà«€àªŸà«‡àª¬àª²</title>

<style>
:root{
  --bg:#f4f6f8;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --border:#d1d5db;
  --green:#1f7a3f;
  --green-light:#e9f6ef;
  --danger:#c53030;
  --radius:12px;
}

/* ğŸŒ¿ FLOATING EMOJI LAYERS */
.emoji-bg,.emoji-fg{ position:fixed; inset:0; pointer-events:none; overflow:hidden; }
.emoji-bg{z-index:0} .emoji-fg{z-index:2}
.emoji{position:absolute;animation:float linear infinite;}
.bg{font-size:34px;opacity:0.60;}
.fg{font-size:50px;opacity:0.15;animation:floatSide linear infinite;}

@keyframes float{ from{transform:translateY(110vh) rotate(0deg)} to{transform:translateY(-20vh) rotate(360deg)} }
@keyframes floatSide{ from{transform:translate(-10vw,110vh) rotate(0deg)} to{transform:translate(10vw,-20vh) rotate(360deg)} }

.permanent-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.2rem;
  color: #d1d5db;
  font-weight: 800;
  text-align: center;
  white-space: nowrap;
  opacity: 0.4;
  z-index: 0;
  pointer-events: none;
  user-select: none;
}

/* -------- UI: APP LAYOUT -------- */
*{box-sizing:border-box}
body{
  margin:0; font-family:system-ui,-apple-system,"Segoe UI",Arial;
  background:var(--bg); color:var(--text);
  height: 100dvh; overflow: hidden; display: flex; justify-content: center;
}
.app{
  position:relative; z-index:1; width:100%; max-width:560px; height: 100%;
  display: flex; flex-direction: column; padding: 8px; gap: 8px; 
}

/* Header */
.header{ text-align:center; padding-top: calc(env(safe-area-inset-top) + 4px); flex-shrink: 0; }
.header h1{ margin:0; font-size:20px; font-weight:800; }
.header p{ margin:2px 0 0; font-size:11px; color:var(--muted); }
#festivalMessage { text-align:center; font-weight:700; font-size:13px; color:var(--green); margin-top: 4px; display:none; }

/* Cards */
.card{
  background:var(--card); border-radius:var(--radius); padding: 10px;
  box-shadow:0 4px 12px rgba(0,0,0,.05); display: flex; flex-direction: column; flex-shrink: 0;
}
#sellerSection, #buyerSection { flex: 1 1 30%; min-height: 0; }
.msg-card { flex: 1 1 35%; min-height: 0; }

/* Scrollable Inner Containers */
.items-container { flex: 1 1 auto; overflow-y: auto; margin-top: 8px; padding-right: 4px; }
.items-container::-webkit-scrollbar { width: 4px; }
.items-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }

/* Inputs & Typography */
label{font-size:13px;font-weight:700;margin-bottom:6px;display:block;}
input,select,textarea,button{ width:100%; padding:8px 10px; font-size:14px; border-radius:8px; border:1px solid #d1d5db; outline:none; background:#fff; }
input:focus, select:focus, textarea:focus { border-color: var(--green); }
textarea{ flex: 1 1 auto; resize:none; background:#fafafa; margin-top:8px;}
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.card-header label { margin: 0; }

/* Mode Selection */
.mode{display:flex;gap:6px;}
.mode button{flex:1;background:#f3f4f6;font-weight:700; font-size: 13px; padding: 8px 0;}
.mode .active{background:var(--green);color:#fff}

/* Basic Grids */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.grid-2x2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 4px; }
.item-row { display: grid; gap: 6px; margin-bottom: 8px; background: #f9fafb; padding: 6px; border-radius: 8px; border: 1px solid var(--border); }
.item-row.normal { grid-template-columns: 1.5fr 1fr 1fr; }
.item-row.advanced { grid-template-columns: 1.5fr 1fr 1fr; }
.item-row.buyer { grid-template-columns: 1fr 1fr 1fr 1fr; }
.buyer-top { grid-column: span 2; }
.hidden{display:none !important;} .other{display:none;}

/* Buttons */
.btn{border:none;font-weight:700; cursor: pointer; transition: 0.2s opacity;}
.btn:active{opacity: 0.7;}
.btn-small{ width: auto; padding: 4px 10px; font-size: 12px; border-radius: 6px; }
.btn-add{background:var(--green-light);color:var(--green)}
.btn-gen{background:var(--green);color:#fff}
.btn-wa{background:#dcfce7;color:#166534}
.btn-copy{background:#eef2ff;color:#1d4ed8}
.btn-clear{background:#fff3f3;color:var(--danger)}
.btn-contact{ background: #eef2ff; color: #1d4ed8; padding: 0; width: 40px; border-radius: 8px; font-size: 18px; margin: 0; display: flex; align-items: center; justify-content: center; flex-shrink: 0;}

/* Footer & Festival Switch */
.bottom-bar { display: flex; justify-content: space-between; align-items: center; padding: 4px 10px; flex-shrink: 0; }
.footer{ font-size:11px; color:var(--muted); display:flex; gap:8px; align-items:center; flex-wrap: wrap;}
.festival-switch select{ width:auto; font-size:11px; padding:4px 8px; border-radius:999px; }

/* ğŸ”” CUSTOM ALERT & BIG UPDATE POPUP BOX */
.custom-alert-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000;
  display: none; justify-content: center; align-items: center; padding: 20px;
  backdrop-filter: blur(4px);
}
.custom-alert-box {
  background: var(--card); border-radius: 20px; padding: 30px 20px;
  text-align: center; width: 100%; max-width: 340px; box-shadow: 0 15px 35px rgba(0,0,0,0.2);
  animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
.custom-alert-icon { font-size: 50px; margin-bottom: 12px; }
.custom-alert-title { font-size: 20px; font-weight: 800; color: var(--green); margin: 0 0 10px; }
.custom-alert-msg { font-size: 14px; margin-bottom: 24px; font-weight: 500; color: var(--muted); line-height: 1.5;}
@keyframes popIn { 0% {transform: scale(0.8); opacity: 0;} 100% {transform: scale(1); opacity: 1;} }

</style>
</head>

<body>
  <span id="appVersion" style="display:none;"></span>

<div class="emoji-bg">
  <div class="permanent-text">Developed by Pritesh Hirani<br>Hirani Tech Â© <span id="bgYear"></span></div>
  <span class="emoji bg" style="left:14%;animation-duration:38s">ğŸ</span> <span class="emoji bg" style="left:62%;animation-duration:27s">ğŸ</span> <span class="emoji bg" style="left:88%;animation-duration:41s">ğŸ</span> <span class="emoji bg" style="left:23%;animation-duration:33s">ğŸŠ</span> <span class="emoji bg" style="left:51%;animation-duration:45s">ğŸ‹</span> <span class="emoji bg" style="left:76%;animation-duration:29s">ğŸŒ</span> <span class="emoji bg" style="left:12%;animation-duration:36s">ğŸ‰</span> <span class="emoji bg" style="left:93%;animation-duration:40s">ğŸ‡</span> <span class="emoji bg" style="left:44%;animation-duration:31s">ğŸ“</span> <span class="emoji bg" style="left:67%;animation-duration:43s">ğŸ«</span> <span class="emoji bg" style="left:35%;animation-duration:26s">ğŸˆ</span> <span class="emoji bg" style="left:10%;animation-duration:40s">ğŸ…</span> <span class="emoji bg" style="left:90%;animation-duration:32s">ğŸ†</span> <span class="emoji bg" style="left:60%;animation-duration:25s">ğŸ¥¦</span> <span class="emoji bg" style="left:15%;animation-duration:34s">ğŸ¥¬</span> <span class="emoji bg" style="left:85%;animation-duration:41s">ğŸ¥’</span> <span class="emoji bg" style="left:41%;animation-duration:35s">ğŸŒ¶ï¸</span> <span class="emoji bg" style="left:58%;animation-duration:38s">ğŸ¥•</span> <span class="emoji bg" style="left:18%;animation-duration:29s">ğŸ¥”</span> <span class="emoji bg" style="left:81%;animation-duration:37s">ğŸ </span>
</div>

<div class="emoji-fg">
  <span class="emoji fg" style="left:72%;animation-duration:34s;font-size:2.4rem">ğŸ«</span> <span class="emoji fg" style="left:15%;animation-duration:42s;font-size:1.8rem">ğŸŒ½</span> <span class="emoji fg" style="left:54%;animation-duration:45s;font-size:2.1rem">ğŸ§…</span> <span class="emoji fg" style="left:92%;animation-duration:26s;font-size:2.7rem">ğŸ¥¦</span> <span class="emoji fg" style="left:67%;animation-duration:33s;font-size:2.3rem">ğŸ¥•</span> <span class="emoji fg" style="left:80%;animation-duration:44s;font-size:2.8rem">ğŸ…</span> <span class="emoji fg" style="left:36%;animation-duration:28s;font-size:1.7rem">ğŸŒ¶ï¸</span> <span class="emoji fg" style="left:95%;animation-duration:46s;font-size:3.0rem">ğŸ¥¬</span> <span class="emoji fg" style="left:52%;animation-duration:37s;font-size:2.2rem">ğŸ¥”</span>
</div>

<div class="app">
<div class="header">
  <h1>ğŸ¥¦ àª¨à«€àª²àª•àª‚àª  àª«à«àª°à«‚àªŸ àªàª¨à«àª¡ àªµà«‡àªœà«€àªŸà«‡àª¬àª²</h1>
  <p>àª­àª¾àªµ â€¢ àª¬àª¿àª² â€¢ àª–àª°à«€àª¦àª¦àª¾àª° â€¢ WhatsApp</p>
  <div id="festivalMessage"></div>
</div>

<div class="card" style="padding: 8px 10px;">
  <div class="mode">
    <button id="mNormal" class="active" onclick="setMode('normal')">ğŸŸ¢ Normal</button>
    <button id="mAdv" onclick="setMode('advanced')">ğŸ”µ Advanced</button>
    <button id="mBuyer" onclick="setMode('buyer')">ğŸ”´ Buyer</button>
  </div>
</div>

<div id="sellerSection" class="card">
  <div class="card-header">
    <label>àª–à«‡àª¡à«‚àª¤ àª…àª¨à«‡ àª­àª¾àªµ</label>
    <button class="btn btn-add btn-small" onclick="addSellerItem()">â• àªµàª§à« àª‰àª®à«‡àª°à«‹</button>
  </div>
  <div class="grid-2">
    <div>
      <select id="farmerSelect" onchange="toggleFarmerOther();fillFarmerMobile()">
        <option value="">àª–à«‡àª¡à«‚àª¤ àªªàª¸àª‚àª¦ àª•àª°à«‹</option>
        <option>JK Hirani</option> <option>Bhumi</option> <option>Kumud</option> <option>Dharmin</option> <option>Shreeji Farm</option> <option>HMV</option> <option value="OTHER">àª…àª¨à«àª¯</option>
      </select>
      <input id="farmerOther" class="other" placeholder="àª¨àª¾àª® àª²àª–à«‹" style="margin-top:6px;">
    </div>
    <div style="display:flex; gap:4px; align-items:flex-start;">
      <input id="farmerMobile" placeholder="àª®à«‹àª¬àª¾àª‡àª² (91...)" style="flex:1;">
      <button class="btn btn-contact" onclick="pickContact('farmer')" title="àª¸àª‚àªªàª°à«àª• àªªàª¸àª‚àª¦ àª•àª°à«‹">ğŸ‘¤</button>
    </div>
  </div>
  <div id="sellerItems" class="items-container"></div>
</div>

<div id="buyerSection" class="card hidden">
  <div class="card-header">
    <label>àª–àª°à«€àª¦àª¦àª¾àª° àª…àª¨à«‡ àª¬àª¿àª²</label>
    <button class="btn btn-add btn-small" onclick="addBuyerItem()">â• àª†àª‡àªŸàª® àª‰àª®à«‡àª°à«‹</button>
  </div>
  <div class="grid-2" style="margin-bottom: 6px;">
    <div>
      <select id="buyerSelect" onchange="toggleBuyerOther();fillBuyerMobile()">
        <option value="">àª–àª°à«€àª¦àª¦àª¾àª° àªªàª¸àª‚àª¦ àª•àª°à«‹</option>
        <option>Mohan</option> <option>Mansoor</option> <option>Ramesh</option> <option value="OTHER">àª…àª¨à«àª¯</option>
      </select>
      <input id="buyerOther" class="other" placeholder="àª¨àª¾àª® àª²àª–à«‹" style="margin-top:6px;">
    </div>
    <div style="display:flex; gap:4px; align-items:flex-start;">
      <input id="buyerMobile" placeholder="àª®à«‹àª¬àª¾àª‡àª² (91...)" style="flex:1;">
      <button class="btn btn-contact" onclick="pickContact('buyer')" title="àª¸àª‚àªªàª°à«àª• àªªàª¸àª‚àª¦ àª•àª°à«‹">ğŸ‘¤</button>
    </div>
  </div>
  <input id="otherExpense" placeholder="àª…àª¨à«àª¯ àª–àª°à«àªš (â‚¹) àª…àª¹à«€ àª²àª–à«‹" style="margin-bottom: 6px;">
  <div id="buyerItems" class="items-container"></div>
</div>

<div class="card msg-card">
  <div class="grid-2x2">
    <button class="btn btn-gen" onclick="generate()">ğŸ“„ àª¸àª‚àª¦à«‡àª¶ àª¬àª¨àª¾àªµà«‹</button>
    <button class="btn btn-wa" onclick="sendWhatsApp()">ğŸ“² WhatsApp</button>
    <button class="btn btn-copy" onclick="copyText()">ğŸ“‹ àª•à«‰àªªà«€ àª•àª°à«‹</button>
    <button class="btn btn-clear" onclick="clearAll()">ğŸ§¹ àª¬àª§à«àª‚ àª•à«àª²àª¿àª¯àª°</button>
  </div>
  <textarea id="message" readonly placeholder="àª¤àª®àª¾àª°à«‹ àª®à«‡àª¸à«‡àªœ àª…àª¹à«€àª‚ àª¦à«‡àª–àª¾àª¶à«‡..."></textarea>
</div>

<div class="bottom-bar">
  <div class="footer">
    <span><strong>Pritesh Hirani</strong> | Hirani Tech Â© <span id="year"></span></span>
    <span style="color:#9ca3af;">â€¢ v<span id="appVer"></span></span>
    <button onclick="manualUpdateCheck()" style="padding:2px 8px; font-size:10px; border-radius:4px; border:1px solid #d1d5db; width:auto; background:var(--card); font-weight:700; color:var(--text);">ğŸ”„ àª…àªªàª¡à«‡àªŸ àªšà«‡àª•</button>
  </div>
  
  <div class="festival-switch" style="display:none">
    <select onchange="manualFestival(this.value)">
      <option value="">Auto Theme ğŸ¨</option>
      <option value="RepublicDay">Republic Day ğŸ‡®ğŸ‡³</option>
      <option value="IndependenceDay">Independence Day ğŸ‡®ğŸ‡³</option>
      <option value="GandhiJayanti">Gandhi Jayanti ğŸ•Šï¸</option>
      <option value="Makar">Makar Sankranti ğŸª</option>
      <option value="Lohri">Lohri ğŸ”¥</option>
      <option value="Pongal">Pongal ğŸŒ¾</option>
      <option value="VasantPanchami">Vasant Panchami ğŸŒ¼</option>
      <option value="Shivratri">Maha Shivratri ğŸ”±</option>
      <option value="Holi">Holi ğŸ¨</option>
      <option value="RamNavami">Ram Navami ğŸ¹</option>
      <option value="HanumanJayanti">Hanuman Jayanti ğŸš©</option>
      <option value="Ugadi">Ugadi ğŸŒ¿</option>
      <option value="AkshayaTritiya">Akshaya Tritiya ğŸ’°</option>
      <option value="BuddhaPurnima">Buddha Purnima â˜¸ï¸</option>
      <option value="RathYatra">Rath Yatra ğŸ›•</option>
      <option value="GuruPurnima">Guru Purnima ğŸ“¿</option>
      <option value="RakshaBandhan">Raksha Bandhan ğŸ§µ</option>
      <option value="Janmashtami">Janmashtami ğŸ¦š</option>
      <option value="GaneshChaturthi">Ganesh Chaturthi ğŸ˜</option>
      <option value="Navratri">Navratri ğŸ’ƒ</option>
      <option value="Dussehra">Dussehra ğŸ¹</option>
      <option value="Diwali">Diwali ğŸª”</option>
      <option value="Govardhan">Govardhan Puja ğŸŒ¿</option>
      <option value="BhaiDooj">Bhai Dooj ğŸ‘«</option>
      <option value="GitaJayanti">Gita Jayanti ğŸ“–</option>
      <option value="Christmas">Christmas ğŸ„</option>
      <option value="Default">Default</option>
    </select>
  </div>
</div>

<div id="updateModal" class="custom-alert-backdrop">
  <div class="custom-alert-box">
    <div class="custom-alert-icon">ğŸš€</div>
    <h2 class="custom-alert-title">àª¨àªµà«àª‚ àª…àªªàª¡à«‡àªŸ àª‰àªªàª²àª¬à«àª§ àª›à«‡!</h2>
    <div class="custom-alert-msg">àªàªªàª®àª¾àª‚ àª¨àªµàª¾ àª«à«€àªšàª°à«àª¸ àª…àª¨à«‡ àª¸à«àª§àª¾àª°àª¾ àª‰àª®à«‡àª°àªµàª¾àª®àª¾àª‚ àª†àªµà«àª¯àª¾ àª›à«‡. àªµàª§à« àª¸àª¾àª°àª¾ àª…àª¨à«àª­àªµ àª®àª¾àªŸà«‡ àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àªàªªàª¨à«‡ àª…àª¤à«àª¯àª¾àª°à«‡ àªœ àª…àªªàª¡à«‡àªŸ àª•àª°à«‹.</div>
    <button class="btn btn-gen" style="font-size: 16px; padding: 12px; border-radius: 999px;" onclick="applyUpdate()">àª…àªªàª¡à«‡àªŸ àª•àª°à«‹ (Update Now)</button>
    <button class="btn" style="background: transparent; color: var(--muted); margin-top: 10px; width: auto;" onclick="closeUpdateModal()">àªªàª›à«€àª¥à«€ (Later)</button>
  </div>
</div>

<div id="customAlert" class="custom-alert-backdrop">
  <div class="custom-alert-box" style="padding: 24px 20px;">
    <div id="customAlertIcon" class="custom-alert-icon" style="font-size: 40px;">âš ï¸</div>
    <div id="customAlertMsg" class="custom-alert-msg" style="color: var(--text); font-weight: 600; margin-bottom: 20px;">Message goes here</div>
    <button class="btn btn-gen" onclick="closeAlert()" style="border-radius: 8px;">àª“àª•à«‡ (OK)</button>
  </div>
</div>

</div>

<script>
// --- CUSTOM ALERT LOGIC ---
function showAlert(msg, icon="âš ï¸") {
  document.getElementById('customAlertMsg').innerText = msg;
  document.getElementById('customAlertIcon').innerText = icon;
  document.getElementById('customAlert').style.display = 'flex';
}
function closeAlert() { document.getElementById('customAlert').style.display = 'none'; }

// --- BIG UPDATE MODAL LOGIC ---
function showUpdateModal() { document.getElementById("updateModal").style.display = "flex"; }
function closeUpdateModal() { document.getElementById("updateModal").style.display = "none"; }

// --- Version & Year Logic ---
const currentMetaVersion = document.querySelector('meta[name="app-version"]')?.getAttribute("content") || "1.0.0";
document.getElementById("appVer").textContent = currentMetaVersion;
const currentYear = new Date().getFullYear();
document.getElementById("year").innerText = currentYear;
document.getElementById("bgYear").innerText = currentYear;

// --- ğŸ› ï¸ SERVICE WORKER & MANUAL UPDATE LOGIC ---
let newWorker;
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").then(reg => {
    reg.addEventListener("updatefound", () => {
      newWorker = reg.installing;
      newWorker.addEventListener("statechange", () => {
        if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
          showUpdateModal();
        }
      });
    });
  });

  let refreshing = false;
  navigator.serviceWorker.addEventListener("controllerchange", () => {
    if (!refreshing) {
      window.location.reload();
      refreshing = true;
    }
  });
}

function applyUpdate() {
  closeUpdateModal();
  localStorage.setItem("APP_VERSION", currentMetaVersion);
  if (newWorker) {
    showAlert("àªàªª àª…àªªàª¡à«‡àªŸ àª¥àªˆ àª°àª¹à«€ àª›à«‡...", "ğŸ”„");
    newWorker.postMessage('FORCE_UPDATE'); 
  } else {
    window.location.reload(true);
  }
}

function manualUpdateCheck() {
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.ready.then(reg => {
      reg.update().then(() => {
        if (!reg.waiting && !reg.installing) {
          showAlert("àª¤àª®àª¾àª°à«€ àªàªª àªªàª¹à«‡àª²àª¾àª¥à«€ àªœ àª²à«‡àªŸà«‡àª¸à«àªŸ àª›à«‡!", "âœ…");
        }
      }).catch(err => {
        showAlert("àª…àªªàª¡à«‡àªŸ àªšà«‡àª• àª•àª°àªµàª¾àª®àª¾àª‚ àª­à«‚àª²! àª‡àª¨à«àªŸàª°àª¨à«‡àªŸ àª¤àªªàª¾àª¸à«‹.", "ğŸ“¶");
      });
    });
  } else {
    window.location.reload(true);
  }
}

// --- ğŸ“± SMART PHONE CLEANER LOGIC ---
function normalizePhone(phone) {
  if (!phone) return "";
  let num = phone.replace(/\D/g, ''); 
  if (num.startsWith('00')) num = num.substring(2); 
  if (num.length === 10) num = '91' + num; 
  if (num.length === 11 && num.startsWith('0')) num = '91' + num.substring(1); 
  return num;
}

// --- ğŸ“ CONTACT PICKER API LOGIC ---
async function pickContact(type) {
  const supported = ('contacts' in navigator && 'ContactsManager' in window);
  if (!supported) {
    showAlert("àª¤àª®àª¾àª°àª¾ àª®à«‹àª¬àª¾àªˆàª²/àª¬à«àª°àª¾àª‰àªàª°àª®àª¾àª‚ àª† àª¸à«àªµàª¿àª§àª¾ àª‰àªªàª²àª¬à«àª§ àª¨àª¥à«€. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª¨àª‚àª¬àª° àªœàª¾àª¤à«‡ àª²àª–à«‹.", "ğŸ“±");
    return;
  }
  
  try {
    const props = ['name', 'tel'];
    const contacts = await navigator.contacts.select(props, { multiple: false });
    
    if (contacts && contacts.length > 0) {
      const contact = contacts[0];
      let name = contact.name ? contact.name[0] : "";
      let rawPhone = contact.tel ? contact.tel[0] : "";
      let cleanPhone = normalizePhone(rawPhone);

      if (type === 'farmer') {
        document.getElementById('farmerSelect').value = "OTHER"; toggleFarmerOther();
        document.getElementById('farmerOther').value = name; document.getElementById('farmerMobile').value = cleanPhone;
      } else if (type === 'buyer') {
        document.getElementById('buyerSelect').value = "OTHER"; toggleBuyerOther();
        document.getElementById('buyerOther').value = name; document.getElementById('buyerMobile').value = cleanPhone;
      }
    }
  } catch (ex) { console.error("Contact picking cancelled.", ex); }
}

let MODE="normal";
let MANUAL_THEME = false;

/* ğŸ‰ FULL FESTIVAL THEMES LOGIC */
const THEMES={
  Default:{ green:"#1f7a3f", bg:"#f4f6f8", emoji:["ğŸ¥¦","ğŸ¥•","ğŸ¥”","ğŸ§…","ğŸ§„","ğŸ¥’","ğŸ†","ğŸŒ¶ï¸","ğŸ«‘","ğŸŒ½","ğŸ¥¬","ğŸ¥—","ğŸ ","ğŸ«›","ğŸ«˜", "ğŸ","ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ«","ğŸ’","ğŸ‘","ğŸ¥­","ğŸ","ğŸ¥","ğŸ…","ğŸˆ","ğŸ‹â€ğŸŸ©","ğŸ¥¥","ğŸ«’","ğŸ¥‘","ğŸ„"], message:"" },
  RepublicDay:{ green:"#0f172a", bg:"#eff6ff", emoji:["ğŸ‡®ğŸ‡³","ğŸª·","ğŸ•Šï¸"], message:"ğŸ‡®ğŸ‡³ Happy Republic Day ğŸ‡®ğŸ‡³" },
  IndependenceDay:{ green:"#15803d", bg:"#ecfdf5", emoji:["ğŸ‡®ğŸ‡³","ğŸª·","ğŸ•Šï¸"], message:"ğŸ‡®ğŸ‡³ Happy Independence Day ğŸ‡®ğŸ‡³" },
  GandhiJayanti:{ green:"#334155", bg:"#f8fafc", emoji:["ğŸ•Šï¸","ğŸ™","ğŸ§˜"], message:"ğŸ•Šï¸ Gandhi Jayanti ğŸ•Šï¸" },
  Makar:{ green:"#d97706", bg:"#fffbeb", emoji:["ğŸª","â˜€ï¸","ğŸŒ¾"], message:"ğŸª Happy Makar Sankranti ğŸª" },
  Lohri:{ green:"#b91c1c", bg:"#fff1f2", emoji:["ğŸ”¥","ğŸŒ¾","ğŸªµ"], message:"ğŸ”¥ Happy Lohri ğŸ”¥" },
  Pongal:{ green:"#15803d", bg:"#f0fdf4", emoji:["ğŸŒ¾","ğŸ¥¥","â˜€ï¸"], message:"ğŸŒ¾ Happy Pongal ğŸŒ¾" },
  VasantPanchami:{ green:"#ca8a04", bg:"#fefce8", emoji:["ğŸŒ¼","ğŸ“š","ğŸª”"], message:"ğŸŒ¼ Happy Vasant Panchami ğŸŒ¼" },
  Shivratri:{ green:"#0f172a", bg:"#f1f5f9", emoji:["ğŸ”±","ğŸ•‰ï¸","ğŸŒ™"], message:"ğŸ”± Happy Maha Shivratri ğŸ”±" },
  Holi:{ green:"#db2777", bg:"#fff1f2", emoji:["ğŸ¨","ğŸŒˆ","ğŸ’¥"], message:"ğŸ¨ Happy Holi ğŸ¨" },
  RamNavami:{ green:"#ea580c", bg:"#fff7ed", emoji:["ğŸ¹","ğŸ•‰ï¸","ğŸŒ¸"], message:"ğŸ¹ Happy Ram Navami ğŸ¹" },
  HanumanJayanti:{ green:"#b91c1c", bg:"#fff7ed", emoji:["ğŸš©","ğŸ’ª","ğŸ•‰ï¸"], message:"ğŸš© Happy Hanuman Jayanti ğŸš©" },
  Ugadi:{ green:"#166534", bg:"#f0fdf4", emoji:["ğŸŒ¿","ğŸ¥­","ğŸª”"], message:"ğŸŒ¿ Happy Ugadi ğŸŒ¿" },
  AkshayaTritiya:{ green:"#ca8a04", bg:"#fffbeb", emoji:["ğŸ’°","ğŸª”","ğŸŒ¸"], message:"ğŸ’° Happy Akshaya Tritiya ğŸ’°" },
  BuddhaPurnima:{ green:"#0f766e", bg:"#f0fdfa", emoji:["â˜¸ï¸","ğŸ•Šï¸","ğŸŒ•"], message:"â˜¸ï¸ Happy Buddha Purnima â˜¸ï¸" },
  RathYatra:{ green:"#7c2d12", bg:"#fff7ed", emoji:["ğŸ›•","ğŸš©","ğŸ™"], message:"ğŸ›• Happy Rath Yatra ğŸ›•" },
  GuruPurnima:{ green:"#334155", bg:"#f8fafc", emoji:["ğŸ“¿","ğŸ™","ğŸŒ•"], message:"ğŸ“¿ Happy Guru Purnima ğŸ“¿" },
  RakshaBandhan:{ green:"#be185d", bg:"#fdf2f8", emoji:["ğŸ§µ","ğŸ’–","ğŸ"], message:"ğŸ§µ Happy Raksha Bandhan ğŸ§µ" },
  Janmashtami:{ green:"#1e40af", bg:"#eff6ff", emoji:["ğŸ¦š","ğŸªˆ","ğŸ‘¶"], message:"ğŸ¦š Happy Janmashtami ğŸ¦š" },
  GaneshChaturthi:{ green:"#c2410c", bg:"#fff7ed", emoji:["ğŸ˜","ğŸŒº","ğŸª”"], message:"ğŸ˜ Happy Ganesh Chaturthi ğŸ˜" },
  Navratri:{ green:"#7c3aed", bg:"#faf5ff", emoji:["ğŸª”","ğŸ’ƒ","ğŸ™"], message:"ğŸª” Happy Navratri ğŸª”" },
  Dussehra:{ green:"#dc2626", bg:"#fff1f2", emoji:["ğŸ¹","ğŸ”¥","ğŸš©"], message:"ğŸ¹ Happy Dussehra ğŸ¹" },
  Diwali:{ green:"#b45309", bg:"#fff7ed", emoji:["ğŸª”","âœ¨","ğŸ†"], message:"ğŸª” Happy Diwali ğŸª”" },
  Govardhan:{ green:"#166534", bg:"#f0fdf4", emoji:["ğŸŒ¿","ğŸ„","ğŸ™"], message:"ğŸŒ¿ Happy Govardhan Puja ğŸŒ¿" },
  BhaiDooj:{ green:"#be185d", bg:"#fdf2f8", emoji:["ğŸ‘«","ğŸ’–","ğŸª”"], message:"ğŸ‘« Happy Bhai Dooj ğŸ‘«" },
  GitaJayanti:{ green:"#1e293b", bg:"#f8fafc", emoji:["ğŸ“–","ğŸ•‰ï¸","ğŸ™"], message:"ğŸ“– Happy Gita Jayanti ğŸ“–" },
  Christmas:{ green:"#166534", bg:"#f0fdf4", emoji:["ğŸ„","â­","ğŸ"], message:"ğŸ„ Merry Christmas ğŸ„" }
};

function applyTheme(t){
  const th = THEMES[t] || THEMES.Default;
  document.documentElement.style.setProperty("--green", th.green); document.documentElement.style.setProperty("--bg", th.bg);
  document.querySelectorAll(".emoji-bg .emoji:not(.permanent)").forEach((e,i)=>{ e.textContent = th.emoji[i % th.emoji.length]; });
  document.querySelectorAll(".emoji-fg .emoji:not(.permanent)").forEach((e,i)=>{ e.textContent = th.emoji[i % th.emoji.length]; });
  const msgBox = document.getElementById("festivalMessage");
  if (th.message) { msgBox.textContent = th.message; msgBox.style.display = "block"; } else { msgBox.style.display = "none"; }
}

function autoFestival(){
  if (MANUAL_THEME) return;
  const d = new Date(); const m = d.getMonth() + 1; const day = d.getDate();
  if (m === 1 && day >= 20 && day <= 30) applyTheme("RepublicDay");
  else if (m === 8 && day >= 1 && day <=15 ) applyTheme("IndependenceDay");
  else if (m === 10 && day === 2) applyTheme("GandhiJayanti");
  else if (m === 1 && day >= 10 && day <= 14) applyTheme("Makar");
  else if (m === 1 && day >= 15 && day <= 16) applyTheme("Lohri");
  else if (m === 1 && day >= 16 && day <= 17) applyTheme("Pongal");
  else if (m === 2 && day >= 1 && day <= 5) applyTheme("VasantPanchami");
  else if (m === 2 && day >= 18 && day <= 25) applyTheme("Shivratri");
  else if (m === 3 && day >= 2 && day <= 20) applyTheme("Holi");
  else if (m === 4 && day >= 1 && day <= 10) applyTheme("RamNavami");
  else if (m === 4 && day >= 14 && day <= 16) applyTheme("HanumanJayanti");
  else if (m === 4 && day >= 1 && day <= 5) applyTheme("Ugadi");
  else if (m === 5 && day >= 1 && day <= 3) applyTheme("AkshayaTritiya");
  else if (m === 5 && day >= 22 && day <= 24) applyTheme("BuddhaPurnima");
  else if (m === 7 && day >= 7 && day <= 9) applyTheme("RathYatra");
  else if (m === 7 && day >= 20 && day <= 22) applyTheme("GuruPurnima");
  else if (m === 8 && day >= 9 && day <= 11) applyTheme("RakshaBandhan");
  else if (m === 8 && day >= 18 && day <= 20) applyTheme("Janmashtami");
  else if (m === 9 && day >= 7 && day <= 17) applyTheme("GaneshChaturthi");
  else if (m === 10 && day >= 3 && day <= 11) applyTheme("Navratri");
  else if (m === 10 && day === 12) applyTheme("Dussehra");
  else if (m === 11 && day >= 1 && day <= 5) applyTheme("Diwali");
  else if (m === 11 && day === 6) applyTheme("Govardhan");
  else if (m === 11 && day === 7) applyTheme("BhaiDooj");
  else if (m === 12 && day >= 7 && day <= 9) applyTheme("GitaJayanti");
  else if (m === 12 && day >= 24 && day <= 25) applyTheme("Christmas");
  else applyTheme("Default");
}

function manualFestival(v){ if (!v) { MANUAL_THEME = false; autoFestival(); } else { MANUAL_THEME = true; applyTheme(v); } }

const VEGS=["àªŸàª¾àª®à«‡àªŸàª¾","àª®àª°àªšàª¾àª‚","àª¬àªŸàª¾àª•àª¾","àª¡à«àª‚àª—àª³à«€","àª•àª¾àª•àª¡à«€","àª—àª¾àªœàª°","àª°à«€àª‚àª—àª£","àª¬àª¾àªœàª°à«€àª¯àª¾ àª°à«€àª‚àª—àª£","àªªàª¾àª²àª•","àª¦à«‚àª§à«€","àªªà«‡àª¤àª°àª—àª¾àª²àª¾"];
function emoji(v){ return {"àªŸàª¾àª®à«‡àªŸàª¾":"ğŸ…","àª®àª°àªšàª¾àª‚":"ğŸŒ¶ï¸","àª¬àªŸàª¾àª•àª¾":"ğŸ¥”","àª¡à«àª‚àª—àª³à«€":"ğŸ§…","àª•àª¾àª•àª¡à«€":"ğŸ¥’","àª—àª¾àªœàª°":"ğŸ¥•","àª°à«€àª‚àª—àª£":"ğŸ†","àª¬àª¾àªœàª°à«€àª¯àª¾ àª°à«€àª‚àª—àª£":"ğŸ†","àªªàª¾àª²àª•":"ğŸ¥¬","àª¦à«‚àª§à«€":"ğŸ¥’","àªªà«‡àª¤àª°àª—àª¾àª²àª¾":"ğŸƒ"}[v]||"ğŸ¥¬"; }

const FARMER_PHONE={"JK Hirani":"919726764636","Bhumi":"919925311805","Kumud":"919925311805","Dharmin":"919879766839","Shreeji Farm":"91","HMV":"91"};
const BUYER_PHONE={"Mohan":"919687575039","Mansoor":"919822222222","Ramesh":"919833333333"};

function setMode(m){
  MODE=m;
  mNormal.classList.toggle("active",m==="normal"); mAdv.classList.toggle("active",m==="advanced"); mBuyer.classList.toggle("active",m==="buyer");
  document.getElementById("sellerSection").classList.toggle("hidden",m==="buyer");
  document.getElementById("buyerSection").classList.toggle("hidden",m!=="buyer");
  clearAll();
}

function toggleFarmerOther(){ document.getElementById("farmerOther").style.display=document.getElementById("farmerSelect").value==="OTHER"?"block":"none"; }
function toggleBuyerOther(){ document.getElementById("buyerOther").style.display=document.getElementById("buyerSelect").value==="OTHER"?"block":"none"; }
function fillFarmerMobile(){ document.getElementById("farmerMobile").value=document.getElementById("farmerSelect").value==="OTHER"?"91":(FARMER_PHONE[document.getElementById("farmerSelect").value]||"91"); }
function fillBuyerMobile(){ document.getElementById("buyerMobile").value=document.getElementById("buyerSelect").value==="OTHER"?"91":(BUYER_PHONE[document.getElementById("buyerSelect").value]||"91"); }

function vegSelect(){
  return `<select class="veg" onchange="toggleVegOther(this)">
    <option value="">àª¶àª¾àª• àªªàª¸àª‚àª¦ àª•àª°à«‹</option> ${VEGS.map(v=>`<option>${v}</option>`).join("")} <option value="OTHER">àª…àª¨à«àª¯ àª²àª–à«‹</option>
  </select>`;
}
function toggleVegOther(sel){ sel.parentElement.querySelector(".other").style.display=sel.value==="OTHER"?"block":"none"; }

function addSellerItem(){
  const r=document.createElement("div"); r.className="item-row "+(MODE==="advanced"?"advanced":"normal");
  r.innerHTML=`<div>${vegSelect()}<input class="other" placeholder="àª¶àª¾àª•àª¨à«àª‚ àª¨àª¾àª®" style="margin-top:4px;"></div>
    <input class="price" type="number" placeholder="àª­àª¾àªµ â‚¹">
    ${MODE==="normal" ? `<input class="price-to" type="number" placeholder="àª¥à«€ â‚¹">` : `<input class="qty" type="number" placeholder="àªµàªœàª¨ (àª•àª¿àª²à«‹)">`}`;
  document.getElementById("sellerItems").appendChild(r);
}

function addBuyerItem(){
  const r=document.createElement("div"); r.className="item-row buyer";
  r.innerHTML=`<div class="buyer-top">${vegSelect()}<input class="other" placeholder="àª¶àª¾àª•àª¨à«àª‚ àª¨àª¾àª®" style="margin-top:4px;"></div>
    <div class="buyer-top"><input class="boxes" type="number" placeholder="àª¬à«‹àª•à«àª¸ àª¨àª‚àª—"></div>
    <input class="qty" type="number" placeholder="àªµàªœàª¨"> <input class="price" type="number" placeholder="àª­àª¾àªµ â‚¹">
    <input class="comm" type="number" placeholder="àª•àª®àª¿àª¶àª¨ %" value="7"> <input class="boxrate" type="number" placeholder="àª®àªœà«‚àª°à«€ â‚¹" value="4">`;
  document.getElementById("buyerItems").appendChild(r);
}

function getDate(){ return new Date().toLocaleDateString("en-GB",{timeZone:"Asia/Kolkata"}); }

function generate(){
  let msg="";
  if(MODE==="buyer"){
    let base=0,comm=0,box=0;
    const buyerSel=document.getElementById("buyerSelect");
    const buyer=buyerSel.value==="OTHER"?document.getElementById("buyerOther").value:buyerSel.value;
    msg=`àª¨àª®àª¸à«àª¤à«‡ ${buyer} ğŸ™\nàª¤àª¾àª°à«€àª–: ${getDate()}\n\n`;

    document.getElementById("buyerItems").querySelectorAll(".item-row").forEach(r=>{
      const veg=r.querySelector(".veg").value==="OTHER"? r.querySelector(".other").value: r.querySelector(".veg").value;
      const p=+r.querySelector(".price").value; const q=+r.querySelector(".qty").value;
      const b=+r.querySelector(".boxes").value; const c=+r.querySelector(".comm").value;
      const br=+r.querySelector(".boxrate").value;
      if(!veg||!p||!q)return;
      const sub=p*q; base+=sub; comm+=sub*(c/100); box+=b*br;
      msg+=`${emoji(veg)} ${veg}\nàª­àª¾àªµ â‚¹${p} Ã— ${q} = â‚¹${sub}\n`;
    });
    const other=+document.getElementById("otherExpense").value||0;
    msg+=`\nàª®àª¾àª²: â‚¹${Math.round(base)}\nàª•àª®àª¿àª¶àª¨: â‚¹${Math.round(comm)}\nàª®àªœà«‚àª°à«€: â‚¹${box}\nàª…àª¨à«àª¯: â‚¹${other}\n\nàª•à«àª² àª¬àª¿àª²: â‚¹${Math.round(base+comm+box+other)}\n\nâ€“ àª¨à«€àª²àª•àª‚àª  àª«à«àª°à«‚àªŸ àªàª¨à«àª¡ àªµà«‡àªœà«€àªŸà«‡àª¬àª²`;
  }else{
    const farmerSel=document.getElementById("farmerSelect");
    const farmer=farmerSel.value==="OTHER"?document.getElementById("farmerOther").value:farmerSel.value;
    msg=`àª¨àª®àª¸à«àª¤à«‡ ${farmer} ğŸ™\nàª¤àª¾àª°à«€àª–: ${getDate()}\n\nàª†àªœàª¨àª¾ àª­àª¾àªµ:\n`;
    document.getElementById("sellerItems").querySelectorAll(".item-row").forEach(r=>{
      const veg=r.querySelector(".veg").value==="OTHER"? r.querySelector(".other").value: r.querySelector(".veg").value;
      const p=r.querySelector(".price").value;
      if(!veg||!p)return;
      if(MODE==="normal"){
        const p2=r.querySelector(".price-to").value; msg+=`${emoji(veg)} ${veg} : â‚¹${p}${p2?` - â‚¹${p2}`:""}\n`;
      }else{
        const q=r.querySelector(".qty").value; msg+=`${emoji(veg)} ${veg} : â‚¹${p} Ã— ${q} = â‚¹${p*q}\n`;
      }
    });
    msg+=`\nâ€“ àª¨à«€àª²àª•àª‚àª  àª«à«àª°à«‚àªŸ àªàª¨à«àª¡ àªµà«‡àªœà«€àªŸà«‡àª¬àª²`;
  }
  document.getElementById("message").value=msg;
}

function sendWhatsApp(){
  generate();
  let rawPhone = MODE === "buyer" ? document.getElementById("buyerMobile").value.trim() : document.getElementById("farmerMobile").value.trim();
  let phone = normalizePhone(rawPhone);
  
  if (!phone || phone.length < 10) { 
    showAlert("àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª¸àª¾àªšà«‹ àª®à«‹àª¬àª¾àª‡àª² àª¨àª‚àª¬àª° àª¦àª¾àª–àª² àª•àª°à«‹.", "ğŸ“±"); 
    return; 
  }
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(document.getElementById("message").value)}`, "_blank");
}

function copyText(){ 
  const msgText = document.getElementById("message").value;
  if(!msgText) { showAlert("àª•à«‹àªªà«€ àª•àª°àªµàª¾ àª®àª¾àªŸà«‡ àª•à«‹àªˆ àª®à«‡àª¸à«‡àªœ àª¨àª¥à«€!", "âš ï¸"); return; }
  document.getElementById("message").select(); document.execCommand("copy"); 
  showAlert("àª®à«‡àª¸à«‡àªœ àª•à«‰àªªà«€ àª¥àªˆ àª—àª¯à«‹ àª›à«‡!", "âœ…");
}

function clearAll(){
  document.getElementById("farmerSelect").value=""; document.getElementById("farmerOther").value=""; document.getElementById("farmerOther").style.display="none";
  document.getElementById("buyerSelect").value=""; document.getElementById("buyerOther").value=""; document.getElementById("buyerOther").style.display="none";
  document.getElementById("sellerItems").innerHTML=""; document.getElementById("buyerItems").innerHTML="";
  document.getElementById("otherExpense").value=""; document.getElementById("message").value="";
  document.getElementById("buyerMobile").value=""; document.getElementById("farmerMobile").value="";
  MODE!=="buyer" ? addSellerItem() : addBuyerItem();
}

window.addEventListener("DOMContentLoaded", () => {
  autoFestival();
  addSellerItem();
  
  const savedVersion = localStorage.getItem("APP_VERSION");
  if (currentMetaVersion && savedVersion && currentMetaVersion !== savedVersion) {
    showUpdateModal(); 
  } else if (!savedVersion) {
    localStorage.setItem("APP_VERSION", currentMetaVersion); 
  }
});
</script>
</body>
</html>
